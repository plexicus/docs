name: Build
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      triggered_by:
        description: "Repository that triggered this build"
        required: false
        default: "manual"
      ui_commit:
        description: "UI repo commit SHA"
        required: false
      ui_ref:
        description: "UI repo branch/ref"
        required: false
      timestamp:
        description: "Trigger timestamp"
        required: false
permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-blog
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Display trigger info
        if: github.event.inputs.triggered_by != 'manual'
        run: |
          echo ":arrows_counterclockwise: Build triggered by: ${{ github.event.inputs.triggered_by }}"
          echo ":memo: UI commit: ${{ github.event.inputs.ui_commit }}"
          echo ":herb: UI ref: ${{ github.event.inputs.ui_ref }}"
          echo ":alarm_clock: Timestamp: ${{ github.event.inputs.timestamp }}"

          
      - name: Install Dependencies
        run: npm install
      - name: Get playwright for mermaid stuff
        run: npx playwright install --with-deps chromium
      - name: Build Blog
        run: npm run build:export

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: blog.plexicus.ai
